#!/usr/local/bin/python3.6

"""
This file prepares every app in the DREBIN dataset such that it can be processed by the feature-reduced models.
For every application in the DREBIN dataset, a definition file is created. This file contains the indexes of all the
 features that app uses.
"""

import os

# path to the file with the definitions
FILE_DEFINTION = './definition_reduced'
# path to file with the SHAs of all malware samples from the dataset
FILE_MALWARES = '../data/malwares_sha256.txt'

# path to the directory with the files from the DREBIN dataset
APP_DIR = '../data/app_features/'
# path to the output directory
OUTPUT_DIR = '../data/apps_feature_indexes_reduced/'

# found feature types that do not belong to any category
NOT_ASSIGNABLE = ['',
                  '[LocalizedFileNames]',
                  '3b16d201ed8bf54964a25e02f6ba59940d44b62fc723c22e9e91408adc57fe87=@3b16d201ed8bf54964a25e02f6ba59940d44b62fc723c22e9e91408adc57fe87,0',
                  '33e93264fbc91ba56a5e28b232d3dd4c083a5dfc432d6336c686b4e7e2451945=@33e93264fbc91ba56a5e28b232d3dd4c083a5dfc432d6336c686b4e7e2451945,0',
                  '24265d499dfed4e6f615f1c4ae4c0fd6b22bc187d895444391856896da81fdd9=@24265d499dfed4e6f615f1c4ae4c0fd6b22bc187d895444391856896da81fdd9,0']

# dictionary for all features per app
# format: { app-name : [featureType::features] }
app_features = {}

# dictionary for all features with index values for the feature vectors
# format: { 'feature' : index }
definition_feature_vector = {}
index = 0

# list with all the sha's of the malwares
malwares = []

print("creating list with app-features...")
with open(FILE_DEFINTION, "r") as file:
    for feature in file:
        feature = feature.strip()

        definition_feature_vector[feature] = index
        index += 1
print(len(definition_feature_vector))
print("finished!\n\n")


print("creating list of malwares...")
with open(FILE_MALWARES, "r") as file:
    for line in file:
        if line:
            malwares.append(line.strip())
print("finished!\n\n")


for filename in os.listdir(APP_DIR):
    with open(APP_DIR + filename, "r") as file:
        # create output-file for app with SHA 'filaname'
        f = open(OUTPUT_DIR + filename.strip(), "a")
        for line in file:
            # extract feature-type
            feature_type = line[:line.find('::')]
            feature = line.strip()

            if feature_type not in NOT_ASSIGNABLE:
                f.write(str(definition_feature_vector[feature]) + '\n')
        f.close()