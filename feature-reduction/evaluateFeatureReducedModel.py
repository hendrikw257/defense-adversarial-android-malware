
"""
 Evaluates a given model with a defined ratio of malware samples in each validation set
"""

#TensorFlow and tf.keras
import tensorflow as tf
from tensorflow import keras

# Helper libraries
import numpy as np
from sklearn import metrics
import matplotlib.pyplot as plt
from tensorflow.keras.utils import plot_model

import os
from random import randint, shuffle

FILE_MALWARES = '../data/malwares_sha256.txt' # path to file with the SHAs of all malware samples from the dataset
DIR_APP_FEATURES = '../data/apps_feature_indexes_reduced/' # directory containing all definition files

# list with all malware samples
MALWARES = []
# list with all cleanware samples
CLEANWARES = []

print("creating list of MALWARES...")
with open(FILE_MALWARES, "r") as file:
    for line in file:
        if line:
            MALWARES.append(line.strip())
print("finished!")

print("creating list of CLEANWARES...")
for filename in os.listdir(DIR_APP_FEATURES):
    if filename not in MALWARES:
        CLEANWARES.append(filename)
print("finished!")


#=========== CLASSIFIER ============== CLASSIFIER ============== CLASSIFIER ===========
#===================================== PARAMETERS =====================================
M = 4109
BATCH_SIZE = 1000
DROPOUT = 0.5
EPOCHS = 10
#======================================================================================
#======================================================================================
def generate_app_set(ratio):
    app_set= []
    # add MALWARES to training data set
    while len(app_set) < (BATCH_SIZE * ratio):
        index = randint(0, len(MALWARES)-1)
        app = MALWARES[index]
        if app not in app_set:
            app_set.append(app)
    # add CLEANWARES to training data set
    while len(app_set) < BATCH_SIZE:
        index = randint(0, len(CLEANWARES)-1)
        app = CLEANWARES[index]
        if app not in app_set:
            app_set.append(app)
    return app_set

def generate_model_input(applist):
    data = np.zeros((len(applist), M), dtype=float)
    labels = np.zeros((len(applist),), dtype=int)

    shuffle(applist)
    for idx, app_sha in enumerate(applist):
        app_sha = app_sha.strip()
        with open(DIR_APP_FEATURES + app_sha, 'r') as app:
            for index in app:
                data[idx][int(index)] = 1.0

        if app_sha in MALWARES:
            labels[idx] = 1
        else:
            labels[idx] = 0

    return data, labels

# path to the directory in that the model was saved
MODEL_DIR = './models/DNN-feature-reduced_200-200_{}.h5'
# malware ratio with that the model should be evaluated
RATIO = 0.3

MODEL_DIR = MODEL_DIR.format(str(RATIO))

model = tf.keras.models.load_model(MODEL_DIR)

averageAcc = 0
averageAcc1 = 0
averageFPR = 0
averageFNR = 0
runs = 5
for i in range(runs):
    val_apps = generate_app_set(RATIO)
    val_data, val_labels = generate_model_input(val_apps)
    predictions = model.predict(val_data)
    confusion = metrics.confusion_matrix(val_labels, np.argmax(predictions, axis=1))
    #print(confusion)
    TP = confusion[1, 1]
    TN = confusion[0, 0]
    FP = confusion[0, 1]
    FN = confusion[1, 0]
    FNR = FN / float(FN+TP)
    FPR = FP / float(FP+TN)
    ACC = ((TP + TN) / float(TP+TN+FP+FN))*100
    averageAcc += ACC
    averageFNR += FNR
    averageFPR += FPR
print('Model {} with ratio {}'.format(MODEL_DIR,RATIO))
averageAcc = averageAcc/runs
averageFPR = averageFPR/runs
averageFNR = averageFNR/runs
print('Accuracy: {}\tFPR: {}\tFNR: {}\n'.format(averageAcc,averageFPR,averageFNR))
print('\n\n')
